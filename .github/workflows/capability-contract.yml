name: Capability Contract

on:
  workflow_dispatch:

jobs:
  parity:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout xint
        uses: actions/checkout@v4

      - name: Checkout xint-rs
        uses: actions/checkout@v4
        with:
          repository: 0xNyk/xint-rs
          path: xint-rs


      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install xint deps
        run: bun install --frozen-lockfile


      - name: Generate manifests
        run: |
          bun run xint.ts capabilities --compact > /tmp/xint-ts-capabilities.json
          cargo run --manifest-path xint-rs/Cargo.toml -- capabilities --compact > /tmp/xint-rs-capabilities.json

      - name: Check contract parity
        run: bun scripts/check-capability-contract.mjs /tmp/xint-ts-capabilities.json /tmp/xint-rs-capabilities.json

      - name: Run MCP envelope contract tests (TypeScript)
        run: bun test lib/mcp-envelope-contract.test.ts

      - name: Run MCP envelope contract tests (Rust)
        run: |
          cargo test --manifest-path xint-rs/Cargo.toml mcp::costs_tool_returns_success_payload_without_network
          cargo test --manifest-path xint-rs/Cargo.toml mcp::cache_clear_tool_returns_success_payload
