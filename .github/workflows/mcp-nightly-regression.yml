name: MCP Nightly Regression

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

jobs:
  regression:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout xint
        uses: actions/checkout@v4

      - name: Checkout xint-rs
        uses: actions/checkout@v4
        with:
          repository: 0xNyk/xint-rs
          path: xint-rs

      - name: Checkout xint-cloud
        uses: actions/checkout@v4
        with:
          repository: 0xNyk/xint-cloud
          path: xint-cloud

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install xint deps
        run: bun install --frozen-lockfile

      - name: Install xint-cloud deps
        run: bun install --frozen-lockfile
        working-directory: xint-cloud

      - name: Generate manifests
        run: |
          bun run xint.ts capabilities --compact > /tmp/xint-ts-capabilities.json
          cargo run --manifest-path xint-rs/Cargo.toml -- capabilities --compact > /tmp/xint-rs-capabilities.json

      - name: Check contract parity
        run: bun scripts/check-capability-contract.mjs /tmp/xint-ts-capabilities.json /tmp/xint-rs-capabilities.json

      - name: Check release version parity
        run: >
          bun scripts/check-release-version-parity.mjs
          package.json
          xint-rs/Cargo.toml
          /tmp/xint-ts-capabilities.json
          /tmp/xint-rs-capabilities.json

      - name: Run MCP envelope contract tests (TypeScript)
        run: bun test lib/mcp-envelope-contract.test.ts

      - name: Run MCP envelope contract tests (Rust)
        run: |
          cargo test --manifest-path xint-rs/Cargo.toml mcp::costs_tool_returns_success_payload_without_network
          cargo test --manifest-path xint-rs/Cargo.toml mcp::cache_clear_tool_returns_success_payload

      - name: Run package API smoke tests (xint-cloud create/query/publish)
        run: bun test src/server.test.ts --filter "package status/search/query/publish/refresh endpoints operate on persisted package state"
        working-directory: xint-cloud
